<div class="poll-admin-container">
  <h2>Szavaz√°s l√©trehoz√°sa</h2>

  <form [formGroup]="pollForm" (ngSubmit)="createPoll()">
    <label for="matchId">V√°lassz meccset:</label>
    <select formControlName="matchId" required>
      <option value="">-- v√°lassz --</option>
      <option *ngFor="let match of matches" [value]="match._id">
        Barcelona vs {{ match.opponent }} ({{ match.date | date:'shortDate' }})
      </option>
    </select>

    <div formArrayName="questions">
      <div *ngFor="let q of questions.controls; let i = index" [formGroupName]="i" class="question-box">
        <label>K√©rd√©s {{ i + 1 }}:</label>
        <input type="text" formControlName="question" placeholder="Pl: Ki fog nyerni?" />
        <button type="button" (click)="removeQuestion(i)" *ngIf="questions.length > 1">‚ùå</button>
      </div>
    </div>

    <button type="button" (click)="addQuestion()">+ √öj k√©rd√©s hozz√°ad√°sa</button>
    <button type="submit" [disabled]="isSubmitting">Szavaz√°s l√©trehoz√°sa</button>
  </form>

  <p class="message">{{ message }}</p>

  <hr />

  <!-- üîΩ Sz≈±r≈ë mez≈ë -->
  <div class="filter-bar">
    <label for="status">Sz≈±r√©s:</label>
    <select id="status" [(ngModel)]="selectedStatus" (change)="onStatusChange()">
      <option value="all">√ñsszes</option>
      <option value="open">Csak akt√≠v</option>
      <option value="closed">Csak lez√°rt</option>
    </select>
  </div>

  <h3>Szavaz√°sok</h3>
  <div *ngFor="let poll of filteredPolls" class="poll-card">
    <h4>
      Meccs: Barcelona vs {{ poll.matchId?.opponent }} ({{ poll.matchId?.date | date:'shortDate' }})
      <span *ngIf="poll.isClosed" class="badge">[Lez√°rva]</span>
    </h4>

    <ul>
      <li *ngFor="let q of poll.questions">üó®Ô∏è {{ q.question }}</li>
    </ul>

    <ng-container *ngIf="!poll.isClosed; else closedBlock">
      <button (click)="closePoll(poll._id)">Lez√°r√°s</button>
      <button (click)="deletePoll(poll._id)">T√∂rl√©s</button>
      <button *ngIf="!isPollEvaluated(poll)" (click)="startEvaluation(poll)">Ki√©rt√©kel√©s</button>
    </ng-container>

    <ng-template #closedBlock>
      <p class="closed-text">Ez a szavaz√°s m√°r le van z√°rva.</p>
      <button (click)="deletePoll(poll._id)">T√∂rl√©s</button>
      <button *ngIf="!isPollEvaluated(poll)" (click)="startEvaluation(poll)">Ki√©rt√©kel√©s</button>
    </ng-template>

    <div *ngIf="evaluatingPollId === poll._id" class="evaluation-box">
      <h5>Ki√©rt√©kel√©s</h5>
      <div *ngFor="let q of poll.questions; let qi = index" class="question-eval">
        <p><strong>{{ q.question }}</strong></p>
        <div *ngFor="let opt of q.options">
          <label>
            <input
              type="checkbox"
              [checked]="evaluationAnswers[qi] && evaluationAnswers[qi].correctAnswers.includes(opt)"
              (change)="toggleCorrectAnswer(qi, opt)" />
            {{ opt }}
          </label>
        </div>
      </div>
      <button (click)="submitEvaluation()">Ki√©rt√©kel√©s ment√©se</button>
    </div>
  </div>
</div>
