<section class="poll-admin-page scroll-fade-in">
  <div class="card poll-form-container">
    <h2>Szavaz√°s l√©trehoz√°sa</h2>

    <form [formGroup]="pollForm" (ngSubmit)="createPoll()" class="poll-form">
      <div class="form-group">
        <label for="matchId">V√°lassz meccset:</label>
        <select formControlName="matchId" required>
          <option value="">-- v√°lassz --</option>
          <option *ngFor="let match of matches" [value]="match._id">
            Barcelona vs {{ match.opponent }} ({{ match.date | date:'shortDate' }})
          </option>
        </select>
      </div>

      <div formArrayName="questions" class="question-list">
        <div *ngFor="let q of questions.controls; let i = index" [formGroupName]="i" class="question-box">
          <label>K√©rd√©s {{ i + 1 }}:</label>
          <div class="question-row">
            <input type="text" formControlName="question" placeholder="Pl: Ki fog nyerni?" />
            <button type="button" class="btn small danger" (click)="removeQuestion(i)" *ngIf="questions.length > 1">‚ùå</button>
          </div>
        </div>
      </div>

      <div class="button-row">
        <button type="button" class="btn secondary" (click)="addQuestion()">+ √öj k√©rd√©s hozz√°ad√°sa</button>
        <button type="submit" class="btn primary" [disabled]="isSubmitting">Szavaz√°s l√©trehoz√°sa</button>
      </div>
    </form>

    <p class="message">{{ message }}</p>
  </div>

  <!-- Sz≈±r≈ë -->
  <div class="filter-bar card scroll-fade-in">
    <label for="status">Sz≈±r√©s:</label>
    <select id="status" [(ngModel)]="selectedStatus" (change)="onStatusChange()">
      <option value="all">√ñsszes</option>
      <option value="open">Csak akt√≠v</option>
      <option value="closed">Csak lez√°rt</option>
    </select>
  </div>

  <h3 class="section-title text-center">Szavaz√°sok</h3>

  <div class="poll-card-grid scroll-fade-in">
    <div *ngFor="let poll of filteredPolls" class="poll-card card">
      <h4>
        Barcelona vs {{ poll.matchId?.opponent }} ({{ poll.matchId?.date | date:'shortDate' }})
        <span *ngIf="poll.isClosed" class="badge">[Lez√°rva]</span>
      </h4>

      <ul>
        <li *ngFor="let q of poll.questions">üó®Ô∏è {{ q.question }}</li>
      </ul>

      <div class="poll-actions">
        <ng-container *ngIf="!poll.isClosed; else closedBlock">
          <button class="btn small secondary" (click)="closePoll(poll._id)">Lez√°r√°s</button>
          <button class="btn small danger" (click)="deletePoll(poll._id)">T√∂rl√©s</button>
          <button class="btn small edit" *ngIf="!isPollEvaluated(poll)" (click)="startEvaluation(poll)">Ki√©rt√©kel√©s</button>
        </ng-container>

        <ng-template #closedBlock>
          <p class="closed-text">Ez a szavaz√°s m√°r le van z√°rva.</p>
          <button class="btn small danger" (click)="deletePoll(poll._id)">T√∂rl√©s</button>
          <button class="btn small edit" *ngIf="!isPollEvaluated(poll)" (click)="startEvaluation(poll)">Ki√©rt√©kel√©s</button>
        </ng-template>
      </div>

      <!-- Ki√©rt√©kel≈ë blokk -->
      <div *ngIf="evaluatingPollId === poll._id" class="evaluation-box">
        <h5>Ki√©rt√©kel√©s</h5>
        <div *ngFor="let q of poll.questions; let qi = index" class="question-eval">
          <p><strong>{{ q.question }}</strong></p>
          <label for="correctSelect">Helyes v√°lasz(ok):</label>
          <label for="correctSelect">Helyes v√°lasz:</label>
          <select
            id="correctSelect"
            [ngModel]="evaluationAnswers[qi].correctAnswers[0]"
            (ngModelChange)="onSingleAnswerChange(qi, $event)">
            <option *ngFor="let opt of q.options" [value]="opt">{{ opt }}</option>
          </select>
        </div>
        <button class="btn primary" (click)="submitEvaluation()">Ki√©rt√©kel√©s ment√©se</button>
        <button class="btn secondary" (click)="cancelEvaluation()">M√©gse</button>
      </div>
    </div>
  </div>
</section>
